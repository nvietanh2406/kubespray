I. Pre requirements:
# Do on ansible node
1.1 Install kubectl:
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256"
echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
kubectl version --client --output=yaml

1.2 Enable shell autocompletion:
source /usr/share/bash-completion/bash_completion
echo 'source <(kubectl completion bash)' >>~/.bashrc
echo 'alias k=kubectl' >>~/.bashrc
echo 'complete -o default -F __start_kubectl k' >>~/.bashrc
source ~/.bashrc

1.3 Gen ssh key:
ssh-keygen -t rsa -b 4096 -C "root@hc-os-ansible01"

1.4 Copy ansible's ssh key:
Copy Ansible's public key to all node (root user)
Eg:
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDLM1J/F7GlSqzOBYBAJMdKLYKPNDvlaHyRdMrLW8+x5pBIB+FtAJgSUnIaCTWrXk5yJnCVYcZMqVnAyAeyd5j2E9egFj3mh4EsdlHbM99Ke4YwXGkLkuX8ttM67AISM805hLhHgOz60DFOZ2alacDv1s0nYOrt/1vEOuaEaTukweFrhlJWDtbYahYnFL3xlDHVGSXHV57uARiQlpRO5R1l+DHg7wjKvbmyjp9V+mazxNY2uFpjIn9V7ArLwOb1RMCHcuxDb5Ry1T1L8eVKQI45h5tz41Ttj9jGcoy63TEH8aApjH5MPZR71PNmrAQT4wvC8OuvYuc3ALUjqcgnNpm03GyrqgcmS0FH8LywZccx2nzQm6ySyCd8dOQL01D78PyFWO+7slxeptbsUrGjNGnQ3J2Eo+IMbAv7zPPdjOnfmvEzvVy5ce513VobjHaPy2xcKV+WExMV1DXxz2vRvZkH9BY3GnyKOGZ71VfNJHKpuiBTt6UsbYTpbLbPHXT0k6yT2tkKPPKITNxInLqlznxrHLWNGtN6PXzECY4ujtTEZtR/pekINKj3wnM/O3HNF1l4/Ay4x03fI95QWckaHDRVL9h7TreH5IauzPP+YJOyCUY3L9BRq0tT3DglZM98FhsuCMnILQNF/dYZnM96F5lu3635P2zFKMYphVfv5az8Hw== root@hc-os-ansible01" >> /root/.ssh/authorized_keys

# Do on worker node
2.1 Install longhorn requirements:
sudo apt update && apt install nfs-common open-iscsi -y
sudo systemctl enable iscsid rpcbind --now

II. Install Kubespray:
# Do on ansible node
1. Install kubespray:
mkdir -p /opt/kubernetes && cd /opt/kubernetes/ 
git clone https://git.datx.com.vn/dso/kubespray.git
cd kubespray
pip install -r requirements.txt
#Deploy kubespray with ansible Playbook
/usr/local/bin/ansible-playbook -i inventory/dev-hoangcau/hosts.yaml  --become --become-user=root cluster.yml

#Copy config file of K8S Cluster  from master01 node to manage node
mkdir /root/.kube 
rsync root@10.32.192.11:/etc/kubernetes/admin.conf /root/.kube/config

#Update server cluster config file on manage node
sed -i 's/127.0.0.1:6443/10.32.192.11:6443/g' /root/.kube/config

#After installing successfully, verify K8S cluster status:
kubectl get node -o wide
kubectl get --raw='/readyz?verbose'

2. Install Helm:
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
chmod +x get_helm.sh
./get_helm.sh
ln -s /usr/local/bin/helm /bin/helm
